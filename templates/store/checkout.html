{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
  .checkout-hero {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 14px;
    padding: 22px 24px;
    box-shadow: 0 1px 0 rgba(0,0,0,.03) inset;
    margin-bottom: 18px;
  }
  .checkout-hero h3 { margin: 0; font-weight: 700; letter-spacing: .2px; }
  .subtle { color:#6c757d; }

  .card {
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,.05);
  }
  .card-title { font-weight: 700; letter-spacing: .2px; }

  .form-group label { font-weight: 600; }
  .form-control, .custom-select {
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,.08);
  }
  .form-control:focus, .custom-select:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 .2rem rgba(13,110,253,.15);
  }
  
  .required-field::after { content: " *"; color: #dc3545; }

  .table-shopping-cart th, .table-shopping-cart td { vertical-align: middle; }
  .table-shopping-cart img.img-sm {
    width: 64px; height: 64px; object-fit: cover; border-radius: 8px;
    border: 1px solid rgba(0,0,0,.06);
  }
  .table thead th {
    background: #f8f9fb;
    border-bottom: 1px solid rgba(0,0,0,.06);
    font-weight: 700;
  }

  @media (min-width: 992px) {
    .sticky-lg-top { position: sticky; top: 24px; }
  }

  .btn-primary { border-radius: 10px; padding: .7rem 1rem; font-weight: 600; }
  .btn-light { border-radius: 10px; padding: .7rem 1rem; border: 1px solid rgba(0,0,0,.08); }
  .section-content.padding-y { padding-top: 24px; padding-bottom: 32px; }
  .is-invalid { border-color: #dc3545 !important; }
  .invalid-feedback { display: block; color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem; }
</style>

<section class="section-content padding-y bg">
  <div class="container">

    <div class="checkout-hero d-flex align-items-center justify-content-between">
      <div>
        <h3>Checkout</h3>
        <div class="subtle small">Step 2 of 3 Â· Billing & Review</div>
      </div>
    </div>

    {% include "includes/alerts.html" %}

    <form action="{% url 'place_order' %}" method="post" novalidate id="checkoutForm">
      {% csrf_token %}

      <div class="row">
        <!-- LEFT: Billing Address -->
        <aside class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title mb-4">Billing Address</h4>

              <div class="form-row">
                <div class="col form-group">
                  <label for="first_name" class="required-field">First Name</label>
                  <input type="text" name="first_name" id="first_name" class="form-control" 
                         required autocomplete="given-name" placeholder="e.g. Arif"
                         value="{{ form_data.first_name|default:'' }}">
                  <div class="invalid-feedback">First name is required.</div>
                </div>
                <div class="col form-group">
                  <label for="last_name" class="required-field">Last Name</label>
                  <input type="text" name="last_name" id="last_name" class="form-control" 
                         required autocomplete="family-name" placeholder="e.g. Hossain"
                         value="{{ form_data.last_name|default:'' }}">
                  <div class="invalid-feedback">Last name is required.</div>
                </div>
              </div>

              <div class="form-row">
                <div class="col form-group">
                  <label for="email" class="required-field">Email Address</label>
                  <input type="email" name="email" id="email" class="form-control" 
                         required autocomplete="email" placeholder="you@example.com"
                         value="{{ form_data.email|default:'' }}">
                  <div class="invalid-feedback">Valid email is required.</div>
                </div>
                <div class="col form-group">
                  <label for="phone" class="required-field">Phone Number</label>
                  <input type="text" name="phone" id="phone" class="form-control" 
                         required autocomplete="tel" placeholder="01XXXXXXXXX"
                         value="{{ form_data.phone|default:'' }}">
                  <div class="invalid-feedback">Phone number is required (min 11 digits).</div>
                </div>
              </div>

              <div class="form-row">
                <div class="col form-group">
                  <label for="address_line_1" class="required-field">Address Line 1</label>
                  <input type="text" name="address_line_1" id="address_line_1" class="form-control" 
                         required autocomplete="address-line1" placeholder="House, Road, Block"
                         value="{{ form_data.address_line_1|default:'' }}">
                  <div class="invalid-feedback">Address is required.</div>
                </div>
                <div class="col form-group">
                  <label for="address_line_2">Address Line 2 <span class="subtle">(optional)</span></label>
                  <input type="text" name="address_line_2" id="address_line_2" class="form-control" 
                         autocomplete="address-line2" placeholder="Apartment, suite, etc."
                         value="{{ form_data.address_line_2|default:'' }}">
                </div>
              </div>

              <div class="form-row">
                <div class="col form-group">
                  <label for="area" class="required-field">Area</label>
                  <input type="text" name="area" id="area" class="form-control" 
                         required placeholder="e.g., Gulshan, Banani, Dhanmondi"
                         value="{{ form_data.area|default:'' }}">
                  <small class="form-text text-muted">Area/locality within district</small>
                  <div class="invalid-feedback">Area is required.</div>
                </div>
                <div class="col form-group">
                  <label for="state" class="required-field">District</label>
                  <select name="state" id="state" class="custom-select" required>
                    <option value="">-- Select District --</option>
                    {% for value, label in districts %}
                      <option value="{{ value }}" {% if form_data.state == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  <div class="invalid-feedback">Please select a district.</div>
                </div>
              </div>

              <div class="form-group">
                <label for="country" class="required-field">Country</label>
                <input type="text" name="country" id="country" class="form-control" 
                       required value="Bangladesh" readonly autocomplete="country-name">
              </div>

              <div class="form-group">
                <label for="order_note">Order Notes</label>
                <textarea name="order_note" id="order_note" rows="3" class="form-control" 
                          placeholder="Additional instructions (optional)">{{ form_data.order_note|default:'' }}</textarea>
              </div>
            </div>
          </div>
        </aside>

        <!-- RIGHT: Order Review -->
        <aside class="col-lg-6 mb-4">
          <div class="card sticky-lg-top">
            <div class="card-body">
              <h4 class="card-title mb-4">Order Review</h4>

              <div class="table-responsive">
                <table class="table table-borderless table-shopping-cart mb-2">
                  <thead class="text-muted">
                    <tr class="small text-uppercase">
                      <th scope="col">Product</th>
                      <th scope="col" width="80" class="text-center">Qty</th>
                      <th scope="col" width="100" class="text-right">Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for cart_item in cart_items %}
                    <tr>
                      <td>
                        <figure class="itemside align-items-center">
                          <div class="aside">
                            <img src="{{ cart_item.product.images.url }}" class="img-sm" alt="{{ cart_item.product.product_name }}">
                          </div>
                          <figcaption class="info">
                            <a href="{{ cart_item.product.get_url }}" class="title text-dark font-weight-bold">
                              {{ cart_item.product.product_name }}
                            </a>
                            <p class="text-muted small mb-0">
                              {% if cart_item.variations.all %}
                                {% for item in cart_item.variations.all %}
                                  {{ item.variation_category|capfirst }}: {{ item.variation_value|capfirst }}<br>
                                {% endfor %}
                              {% endif %}
                            </p>
                          </figcaption>
                        </figure>
                      </td>
                      <td class="text-center align-middle">
                        <span class="badge badge-light px-3 py-2" style="font-weight:600;">{{ cart_item.quantity }}</span>
                      </td>
                      <td class="text-right align-middle">
                        <div class="price-wrap">
                          <div class="price font-weight-bold">Tk. {{ cart_item.sub_total }}</div>
                          <small class="text-muted">Tk. {{ cart_item.product.price }} each</small>
                        </div>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <hr class="my-3">

              <div class="d-grid">
                <button type="submit" name="submit" class="btn btn-primary btn-block mb-2">
                  Proceed to Payment
                </button>
                <a href="{% url 'store' %}" class="btn btn-light btn-block">
                  Continue Shopping
                </a>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </form>

  </div>
</section>

<script>
// Auto-fill form from user profile or last order
document.addEventListener('DOMContentLoaded', function() {
  const userData = {{ user_data|safe }};
  
  if (userData && Object.keys(userData).length > 0) {
    const fields = ['first_name', 'last_name', 'email', 'phone', 'address_line_1', 'address_line_2', 'area', 'state'];
    
    fields.forEach(function(fieldName) {
      const field = document.getElementById(fieldName);
      if (field && !field.value && userData[fieldName]) {
        field.value = userData[fieldName];
      }
    });
  }
});

// Form validation
document.getElementById('checkoutForm').addEventListener('submit', function(e) {
  let isValid = true;
  const form = this;
  
  // Clear previous validation states
  form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
  
  // Validate first name
  const firstName = document.getElementById('first_name');
  if (!firstName.value.trim()) {
    firstName.classList.add('is-invalid');
    isValid = false;
  }
  
  // Validate last name
  const lastName = document.getElementById('last_name');
  if (!lastName.value.trim()) {
    lastName.classList.add('is-invalid');
    isValid = false;
  }
  
  // Validate email
  const email = document.getElementById('email');
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email.value.trim() || !emailPattern.test(email.value)) {
    email.classList.add('is-invalid');
    isValid = false;
  }
  
  // Validate phone
  const phone = document.getElementById('phone');
  if (!phone.value.trim() || phone.value.replace(/\D/g, '').length < 11) {
    phone.classList.add('is-invalid');
    isValid = false;
  }
  
  // Validate address line 1
  const address = document.getElementById('address_line_1');
  if (!address.value.trim()) {
    address.classList.add('is-invalid');
    isValid = false;
  }
  
  // Validate area (now required)
  const area = document.getElementById('area');
  if (!area.value.trim()) {
    area.classList.add('is-invalid');
    isValid = false;
  }
  
  // Validate district
  const state = document.getElementById('state');
  if (!state.value) {
    state.classList.add('is-invalid');
    isValid = false;
  }
  
  if (!isValid) {
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Show alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
    alertDiv.innerHTML = `
      <strong>Error!</strong> Please fill in all required fields marked with *.
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    `;
    
    const container = document.querySelector('.checkout-hero');
    if (container.nextElementSibling && container.nextElementSibling.classList.contains('alert')) {
      container.nextElementSibling.remove();
    }
    container.insertAdjacentElement('afterend', alertDiv);
  }
});

// Real-time validation feedback
const requiredFields = ['first_name', 'last_name', 'email', 'phone', 'address_line_1', 'area', 'state'];
requiredFields.forEach(function(fieldId) {
  const field = document.getElementById(fieldId);
  if (field) {
    field.addEventListener('blur', function() {
      if (this.value.trim()) {
        this.classList.remove('is-invalid');
      }
    });
  }
});
</script>

{% endblock %}