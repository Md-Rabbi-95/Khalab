{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="py-4 bg-light">
  <div class="container" style="max-width: 920px;">
    <!-- Header / Brand -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-3">
        <img src="{% static 'images/logo.png' %}" alt="Logo" style="height:40px">
        <div class="text-muted small d-none d-md-block">Order Summary & Invoice</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">Print Invoice</button>
        <a href="javascript:history.back()" class="btn btn-primary btn-sm">Back</a>
      </div>
    </div>

    <!-- Invoice Card -->
    <article id="print-area" class="card shadow-sm border-0">
      <div class="card-body p-4">
        <!-- Top Row: Billing + Order Meta -->
        <div class="row g-4">
          <div class="col-md-6">
            <h6 class="mb-2 text-uppercase text-muted">Invoiced To</h6>
            <ul class="list-unstyled mb-0">
              <li class="fw-semibold">{{ order.full_name }}</li>
              <li>{{ order.full_address }}</li>
              <li>{{ order.area }} {{ order.city }}</li>
              <li>{{ order.country }}</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 class="mb-2 text-uppercase text-muted">Order Details</h6>
            <ul class="list-unstyled mb-0">
              <li>
                <span class="text-muted">Order #:</span>
                <span class="fw-semibold">{{ order.order_number }}</span>
              </li>

              {# Transaction only for non-COD #}
              {% if order.payment and order.payment.payment_method != "COD" %}
              <li>
                <span class="text-muted">Transaction:</span>
                {% if order.payment.transaction_id %}
                  {{ order.payment.transaction_id }}
                {% else %}
                  {{ order.payment.payment_id }}
                {% endif %}
              </li>
              {% endif %}

              <li>
                <span class="text-muted">Order Date:</span>
                {{ order.created_at|date:"M d, Y h:i A" }}
              </li>

              {# ORDER STATUS — dynamically from DB with color badge #}
              <li>
                <span class="text-muted">Order Status:</span>
                {% with s=order.status|lower %}
                  {% if s == "new" %}
                    <span class="badge bg-secondary">{{ order.status }}</span>
                  {% elif s == "accept" %}
                    <span class="badge bg-info text-dark">{{ order.status }}</span>
                  {% elif s == "completed" %}
                    <span class="badge bg-success">{{ order.status }}</span>
                  {% elif s == "cancelled" %}
                    <span class="badge bg-danger">{{ order.status }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ order.status }}</span>
                  {% endif %}
                {% endwith %}
              </li>

              {# ✅ PAYMENT STATUS — Fully Dynamic from model properties #}
              <li>
                <span class="text-muted">Payment Status:</span>
                <span class="badge {{ order.payment_status_badge }}">
                  {{ order.payment_status_label }}
                </span>
                {% if order.payment %}
                  <div class="small text-muted mt-1">
                    Updated: {{ order.payment.created_at|date:"M d, Y h:i A" }}
                  </div>
                {% endif %}
              </li>
            </ul>
          </div>
        </div>

        <!-- Items -->
        <div class="table-responsive mt-4">
          <table class="table table-striped align-middle">
            <thead class="table-light">
              <tr class="text-uppercase small text-muted">
                <th>Products</th>
                <th class="text-center">Qty</th>
                <th class="text-end" style="width:50px;">Tk.</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in order_detail %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ item.product.product_name }}</div>
                  <div class="text-muted small">
                    {% if item.variations.all %}
                      {% for i in item.variations.all %}
                        {{ i.variation_category|capfirst }}: {{ i.variation_value|capfirst }}<br>
                      {% endfor %}
                    {% endif %}
                  </div>
                </td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-end">Tk.</td>
                <td class="text-end amount">{{ item.product_price|floatformat:2 }}</td>
              </tr>
              {% endfor %}
            </tbody>

            <!-- Summary rows -->
            <tfoot class="border-top">
              <tr>
                <td colspan="2" class="text-end fw-semibold">Sub Total:</td>
                <td class="text-end">Tk.</td>
                <td class="text-end amount">{{ subtotal|floatformat:2 }}</td>
              </tr>
              <tr>
                <td colspan="2" class="text-end fw-semibold">Delivery Charge:</td>
                <td class="text-end">Tk.</td>
                <td class="text-end amount">{{ order.delivery_charge|floatformat:2 }}</td>
              </tr>
              <tr class="table-dark">
                <td colspan="2" class="text-end fw-bold fs-5">Grand Total:</td>
                <td class="text-end">Tk.</td>
                <td class="text-end fw-bold fs-5 amount">{{ order.order_total|floatformat:2 }}</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Footer -->
        <div class="pt-3 border-top mt-3">
          <p class="text-center text-muted mb-0">Thank you for shopping with us!</p>
        </div>
      </div>
    </article>
  </div>
</section>

<style>
  /* Align numbers like receipts/invoices */
  .amount {
    font-variant-numeric: tabular-nums;
    font-family: "Courier New", monospace;
    min-width: 100px;
    display: inline-block;
    text-align: right;
    letter-spacing: 0.3px;
  }

  /* Print only the invoice card */
  @media print {
    @page { size: A4; margin: 12mm 10mm; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    body * { visibility: hidden !important; }
    #print-area, #print-area * { visibility: visible !important; }
    #print-area {
      position: absolute; left: 0; top: 0; width: 100%;
      box-shadow: none !important; border: none !important; background: #fff !important;
    }
  }
</style>
{% endblock %}
