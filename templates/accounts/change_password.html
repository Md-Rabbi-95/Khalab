{% extends 'base.html' %}

{% block content %}
<section class="bg-ecom py-4">
  {% include 'includes/alerts.html' %}

  <div class="container">
    <div class="row">
      {% include 'includes/dashboard_sidebar.html' %}

      <main class="col-md-9">
        <!-- Branded header -->
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div>
            <h4 class="mb-1 fw-semibold">Change Password</h4>
            <div class="text-muted small">Keep your account secure with a strong, unique password.</div>
          </div>
          <a href="{% url 'dashboard' %}" class="btn btn-link text-decoration-none p-0">Back to Account</a>
        </div>

        <!-- Card -->
        <article class="card card-ecom border-0 shadow-sm">
          <div class="card-body p-4">
            <form action="{% url 'change_password' %}" method="POST" novalidate>
              {% csrf_token %}

              <div class="mb-3">
                <label class="form-label fw-500">Current Password</label>
                <div class="position-relative">
                  <input type="password" name="current_password" id="id_current_password"
                         class="form-control form-control-lg pe-5" placeholder="Enter current password" required>
                  <button type="button" class="btn btn-sm btn-link toggle-eye" data-target="id_current_password">Show</button>
                </div>
                <small id="caps-current" class="text-warning d-none">Caps Lock is ON.</small>
              </div>

              <div class="mb-3">
                <label class="form-label fw-500">New Password</label>
                <div class="position-relative">
                  <input type="password" name="new_password" id="id_new_password"
                         class="form-control form-control-lg pe-5" placeholder="Create new password"
                         required autocomplete="new-password">
                  <button type="button" class="btn btn-sm btn-link toggle-eye" data-target="id_new_password">Show</button>
                </div>
                <!-- Strength meter -->
                <div class="progress mt-2" style="height: 6px;">
                  <div id="pwdStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted">Use 8+ characters with a mix of letters, numbers, and symbols.</small>
                <small id="caps-new" class="text-warning d-none ms-2">Caps Lock is ON.</small>
              </div>

              <div class="mb-3">
                <label class="form-label fw-500">Confirm New Password</label>
                <div class="position-relative">
                  <input type="password" name="confirm_password" id="id_confirm_password"
                         class="form-control form-control-lg pe-5" placeholder="Re-enter new password"
                         required autocomplete="new-password">
                  <button type="button" class="btn btn-sm btn-link toggle-eye" data-target="id_confirm_password">Show</button>
                </div>
                <small id="caps-confirm" class="text-warning d-none">Caps Lock is ON.</small>
              </div>

              <div class="d-flex align-items-center gap-2 mt-4">
                <input type="submit" value="Save Changes" class="btn btn-brand px-4">
                <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Cancel</a>
              </div>
            </form>
          </div>
        </article>
      </main>
    </div>
  </div>
</section>

<style>
  /* Branded surface */
  .bg-ecom { background: #f5f6f8; }
  .card-ecom { border-radius: 10px; }

  /* Typography */
  .fw-500 { font-weight: 500; }

  /* Inputs */
  .form-control { border-radius: 8px; }
  .form-control-lg { padding-top: .8rem; padding-bottom: .8rem; }

  /* Toggle eye */
  .toggle-eye{
    position:absolute; right:.25rem; top:50%; transform:translateY(-50%);
    color:#0a58ca; text-decoration:none;
  }


.btn-brand{
  background: #0d6efd;   /* Bootstrap primary blue */
  border-color: #0d6efd;
  color:#fff; font-weight:600;
  box-shadow: 0 2px 0 rgba(0,0,0,.05);
}
.btn-brand:hover{
  background:#0b5ed7;
  border-color:#0a58ca;
  color:#fff;
}

</style>

<script>
  // toggle show/hide
  document.querySelectorAll('.toggle-eye').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id = btn.getAttribute('data-target');
      const input = document.getElementById(id);
      if(!input) return;
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      btn.textContent = isPwd ? 'Hide' : 'Show';
    });
  });

  // caps lock detection
  function capsWatcher(inputId, warnId){
    const input = document.getElementById(inputId);
    const warn  = document.getElementById(warnId);
    if(!input || !warn) return;
    input.addEventListener('keyup', (e)=>{
      const caps = e.getModifierState && e.getModifierState('CapsLock');
      warn.classList.toggle('d-none', !caps);
    });
  }
  capsWatcher('id_current_password','caps-current');
  capsWatcher('id_new_password','caps-new');
  capsWatcher('id_confirm_password','caps-confirm');

  // simple strength meter
  const pwd = document.getElementById('id_new_password');
  const bar = document.getElementById('pwdStrength');
  if(pwd && bar){
    pwd.addEventListener('input', ()=>{
      const v = pwd.value || '';
      let score = 0;
      if(v.length >= 8) score += 25;
      if(/[A-Z]/.test(v)) score += 20;
      if(/[a-z]/.test(v)) score += 20;
      if(/\d/.test(v))    score += 20;
      if(/[^A-Za-z0-9]/.test(v)) score += 15;

      bar.style.width = Math.min(score,100) + '%';
      bar.className = 'progress-bar'; // reset
      if(score < 40)      bar.classList.add('bg-danger');
      else if(score < 70) bar.classList.add('bg-warning');
      else                bar.classList.add('bg-success');
    });
  }
</script>
{% endblock %}
